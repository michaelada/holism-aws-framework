# Production Docker Compose override
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

version: '3.8'

services:
  backend:
    build:
      target: production
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
    restart: unless-stopped

  frontend:
    build:
      target: production
    restart: unless-stopped

  admin:
    build:
      target: production
    restart: unless-stopped

  nginx:
    volumes:
      # Use SSL-enabled configuration
      - ./infrastructure/nginx/default-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      # Mount SSL certificates (update paths as needed)
      - /etc/letsencrypt/live/yourdomain.com/fullchain.pem:/etc/nginx/ssl/cert.pem:ro
      - /etc/letsencrypt/live/yourdomain.com/privkey.pem:/etc/nginx/ssl/key.pem:ro
    restart: unless-stopped

  postgres:
    restart: unless-stopped
    # Use persistent volume for production data
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data

  keycloak:
    restart: unless-stopped
    environment:
      KC_HOSTNAME_STRICT: true
      KC_HOSTNAME_STRICT_HTTPS: true
      KC_HTTP_ENABLED: false
      KC_HTTPS_ENABLED: true
    command: start

  prometheus:
    restart: unless-stopped

  grafana:
    restart: unless-stopped

volumes:
  postgres_data_prod:
    driver: local
